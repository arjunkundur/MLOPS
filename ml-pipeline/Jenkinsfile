pipeline {
    agent any

    environment {
        AWS_REGION = 'ap-south-1'
        SAGEMAKER_PROJECT = 'my-sagemaker-aws-jenkins-project1'
        SAGEMAKER_ROLE = 'arn:aws:iam::975050337104:role/service-role/AmazonSageMaker-ExecutionRole-20250311T162664'
        AWS_CREDENTIALS = credentials('aws-credentials')
        SPECIFIC_TRAINING_JOB = 'sagemaker-xgboost-2025-03-26-08-57-40-665'
        INSTANCE_TYPE = 'ml.m5.large'
        ENDPOINT_NAME = "${SAGEMAKER_PROJECT}-endpoint"
        CONFIG_NAME = "${SAGEMAKER_PROJECT}-config-${currentBuild.number}"
        PYTHON = 'python3'
        // Official SageMaker XGBoost image for ap-south-1
        XGBOOST_IMAGE = '257758044811.dkr.ecr.ap-south-1.amazonaws.com/sagemaker-xgboost:1.5-1'
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    extensions: [[
                        $class: 'RelativeTargetDirectory',
                        relativeTargetDir: 'ml-pipeline'
                    ]],
                    userRemoteConfigs: [[url: 'https://github.com/arjunkundur/MLOPS.git']]
                ])
            }
        }

        stage('Setup Environment') {
            steps {
                dir('ml-pipeline') {
                    sh '''
                    echo "Setting up Python environment"
                    pip3 install --upgrade pip
                    pip3 install -r sagemaker_scripts/requirements.txt
                    pip3 install awscli boto3 sagemaker
                    aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
                    aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
                    aws configure set region $AWS_REGION
                    '''
                }
            }
        }

        stage('Verify Training Job') {
            steps {
                dir('ml-pipeline') {
                    script {
                        echo "Verifying training job: ${SPECIFIC_TRAINING_JOB}"
                        
                        env.JOB_INFO = sh(
                            script: """
                            aws sagemaker describe-training-job \\
                                --training-job-name ${SPECIFIC_TRAINING_JOB} \\
                                --query '[TrainingJobStatus, ModelArtifacts.S3ModelArtifacts]' \\
                                --output text
                            """,
                            returnStdout: true
                        ).trim()
                        
                        def jobInfo = env.JOB_INFO.split('\t')
                        
                        if (jobInfo[0] != 'Completed') {
                            error("Training job ${SPECIFIC_TRAINING_JOB} status: ${jobInfo[0]}")
                        }
                        echo "✅ Verified model artifacts: ${jobInfo[1]}"
                        env.MODEL_ARTIFACTS = jobInfo[1]
                    }
                }
            }
        }

        stage('Create Model Config') {
            steps {
                dir('ml-pipeline') {
                    script {
                        echo "Creating model configuration: ${CONFIG_NAME}"
                        
                        // Create Model
                        sh """
                        aws sagemaker create-model \\
                            --model-name ${SAGEMAKER_PROJECT}-model-${currentBuild.number} \\
                            --execution-role-arn ${SAGEMAKER_ROLE} \\
                            --primary-container '{
                                "Image": "${XGBOOST_IMAGE}",
                                "ModelDataUrl": "${env.MODEL_ARTIFACTS}",
                                "Environment": {
                                    "SAGEMAKER_PROGRAM": "xgboost_train.py",
                                    "SAGEMAKER_SUBMIT_DIRECTORY": "${env.MODEL_ARTIFACTS}"
                                }
                            }'
                        """
                        
                        // Create Endpoint Config
                        sh """
                        aws sagemaker create-endpoint-config \\
                            --endpoint-config-name ${CONFIG_NAME} \\
                            --production-variants '[
                                {
                                    "VariantName": "main",
                                    "ModelName": "${SAGEMAKER_PROJECT}-model-${currentBuild.number}",
                                    "InitialInstanceCount": 1,
                                    "InstanceType": "${INSTANCE_TYPE}",
                                    "InitialVariantWeight": 1.0
                                }
                            ]'
                        """
                    }
                }
            }
        }

        stage('Deploy Model') {
            steps {
                dir('ml-pipeline') {
                    script {
                        echo "Starting deployment to endpoint: ${ENDPOINT_NAME}"
                        
                        try {
                            // Use the improved deploy_model.py script
                            def deployOutput = sh(
                                script: """
                                ${PYTHON} scripts/deploy_model.py \\
                                    --endpoint-name ${ENDPOINT_NAME} \\
                                    --config-name ${CONFIG_NAME} \\
                                    --region ${AWS_REGION}
                                """,
                                returnStdout: true
                            ).trim()
                            
                            echo "Deployment output:\n${deployOutput}"
                            
                            if (deployOutput.contains("❌") || deployOutput.contains("failed")) {
                                error("Deployment script reported failure")
                            }
                            
                            // Verify deployment
                            def endpointStatus = ""
                            def attempts = 0
                            def maxAttempts = 30
                            def interval = 30
                            
                            while (attempts < maxAttempts) {
                                attempts++
                                sleep(interval)
                                
                                endpointStatus = sh(
                                    script: """
                                    aws sagemaker describe-endpoint \\
                                        --endpoint-name ${ENDPOINT_NAME} \\
                                        --query 'EndpointStatus' \\
                                        --output text
                                    """,
                                    returnStdout: true
                                ).trim()
                                
                                echo "Endpoint status: ${endpointStatus} (attempt ${attempts}/${maxAttempts})"
                                
                                if (endpointStatus == 'InService') {
                                    break
                                } else if (endpointStatus == 'Failed') {
                                    error("Endpoint deployment failed")
                                }
                            }
                            
                            if (endpointStatus != 'InService') {
                                error("Endpoint did not reach InService status within timeout")
                            }
                            
                            echo "✅ Deployment successful! Endpoint: ${ENDPOINT_NAME}"
                            
                        } catch (Exception e) {
                            error("Deployment failed: ${e.getMessage()}")
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline execution completed"
            dir('ml-pipeline') {
                // Cleanup if needed
            }
        }
        success {
            echo "✅ Pipeline succeeded!"
            // slackSend(color: 'good', message: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}")
        }
        failure {
            echo "❌ Pipeline failed"
            // slackSend(color: 'danger', message: "FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}")
        }
    }
}