pipeline {
    agent any

    environment {
        AWS_REGION = 'ap-south-1'
        SAGEMAKER_PROJECT = 'my-sagemaker-aws-jenkins-project1'
        SAGEMAKER_ROLE = 'arn:aws:iam::975050337104:role/service-role/AmazonSageMaker-ExecutionRole-20250311T162664'
        AWS_CREDENTIALS = credentials('aws-credentials')
        SPECIFIC_TRAINING_JOB = 'sagemaker-xgboost-2025-03-26-08-57-40-665'
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    extensions: [[
                        $class: 'RelativeTargetDirectory',
                        relativeTargetDir: 'ml-pipeline'
                    ]],
                    userRemoteConfigs: [[url: 'https://github.com/arjunkundur/MLOPS.git']]
                ])
            }
        }

        stage('Setup Environment') {
            steps {
                dir('ml-pipeline') {
                    sh '''
                    echo "Setting up Python environment"
                    pip3 install --upgrade pip
                    pip3 install -r sagemaker_scripts/requirements.txt
                    pip3 install awscli boto3 sagemaker
                    aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
                    aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
                    aws configure set region $AWS_REGION
                    '''
                }
            }
        }

        stage('Verify Training Job') {
            steps {
                dir('ml-pipeline') {
                    script {
                        echo "Verifying training job: ${SPECIFIC_TRAINING_JOB}"
                        
                        def jobStatus = sh(
                            script: """
                            aws sagemaker describe-training-job \\
                                --training-job-name ${SPECIFIC_TRAINING_JOB} \\
                                --query 'TrainingJobStatus' \\
                                --output text
                            """,
                            returnStdout: true
                        ).trim()
                        
                        if (jobStatus != 'Completed') {
                            error("Training job ${SPECIFIC_TRAINING_JOB} status: ${jobStatus}")
                        }
                        
                        def modelData = sh(
                            script: """
                            aws sagemaker describe-training-job \\
                                --training-job-name ${SPECIFIC_TRAINING_JOB} \\
                                --query 'ModelArtifacts.S3ModelArtifacts' \\
                                --output text
                            """,
                            returnStdout: true
                        ).trim()
                        
                        echo "Verified model artifacts: ${modelData}"
                        env.MODEL_DATA_URL = modelData
                    }
                }
            }
        }

        stage('Deploy Model') {
            steps {
                dir('ml-pipeline') {
                    script {
                        echo "Deploying SPECIFIC model from job: ${SPECIFIC_TRAINING_JOB}"
                        
                        sh """
                        python3 scripts/deploy_model.py \\
                            --project $SAGEMAKER_PROJECT \\
                            --region $AWS_REGION \\
                            --training-job-name $SPECIFIC_TRAINING_JOB
                        """
                        
                        // Verify deployment
                        def maxAttempts = 60
                        def interval = 30
                        
                        for (int i = 0; i < maxAttempts; i++) {
                            sleep(interval)
                            
                            def endpointInfo = sh(
                                script: """
                                aws sagemaker describe-endpoint \\
                                    --endpoint-name ${SAGEMAKER_PROJECT}-endpoint \\
                                    --query '[EndpointStatus, ProductionVariants[0].ModelName]' \\
                                    --output text
                                """,
                                returnStdout: true
                            ).trim().split('\t')
                            
                            def endpointStatus = endpointInfo[0]
                            def modelName = endpointInfo.size() > 1 ? endpointInfo[1] : ''
                            
                            echo "Endpoint status: ${endpointStatus}, Model: ${modelName}"
                            
                            if (endpointStatus == 'InService') {
                                if (!modelName.contains(SPECIFIC_TRAINING_JOB.substring(SPECIFIC_TRAINING_JOB.length() - 8))) {
                                    error("Deployed model verification failed! Wrong model detected")
                                }
                                echo "Successfully deployed model from ${SPECIFIC_TRAINING_JOB}"
                                break
                            } else if (endpointStatus == 'Failed') {
                                error("Endpoint deployment failed")
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline execution completed"
            dir('ml-pipeline') {
                sh 'rm -rf venv'
            }
        }
        success {
            echo "Pipeline succeeded!"
        }
        failure {
            echo "Pipeline failed"
        }
    }
}